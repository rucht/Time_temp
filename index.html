<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Fortunately</title>

<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  
  :root {
    --bg-gradient: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
    --card-bg: rgba(255, 255, 255, 0.15);
    --text-color: #fff;
    --currency-num-color: #003366; 
    --card-border: rgba(255, 255, 255, 0.3);
    --btn-bg: #ffeb3b;
    --btn-text: #333;
    --input-bg: rgba(255, 255, 255, 0.8);
    --mine-bg: rgba(255, 255, 255, 0.25);
    --mine-revealed: rgba(255, 255, 255, 0.5);
    --accent-color: #ffeb3b;
  }

  body {
    font-family: "Poppins", sans-serif;
    background: var(--bg-gradient);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    color: var(--text-color);
    transition: background 0.5s ease;
    padding-top: 80px;
  }

  body.dark-mode {
    --bg-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    --card-bg: rgba(0, 0, 0, 0.5);
    --text-color: #e0e0e0;
    --currency-num-color: #4db8ff; 
    --card-border: rgba(255, 255, 255, 0.1);
    --btn-bg: #4db8ff;
    --btn-text: #000;
    --input-bg: rgba(30, 30, 30, 0.8);
    --mine-bg: rgba(255, 255, 255, 0.15); 
    --mine-revealed: rgba(255, 255, 255, 0.1);
    --accent-color: #4db8ff;
  }

  /* --- COMMON UI ELEMENTS --- */
  .theme-toggle {
    position: absolute; top: 20px; right: 20px;
    background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.4);
    color: #fff; font-size: 1.5rem; width: 45px; height: 45px; border-radius: 50%;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: all 0.3s; z-index: 100;
  }
  .theme-toggle:hover { background: rgba(255, 255, 255, 0.4); transform: scale(1.1); }
  
  .loading { opacity: 0.5; pointer-events: none; cursor: wait; }

  /* --- CURRENCY TICKER --- */
  #currency-ticker {
    position: absolute; top: 25px; left: 20px;
    background: var(--card-bg); backdrop-filter: blur(5px);
    border: 1px solid var(--card-border); border-radius: 20px;
    padding: 8px 15px; display: flex; gap: 15px;
    font-weight: 500; font-size: 0.85rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 99; flex-wrap: wrap;
  }
  .currency-item span { color: var(--currency-num-color); margin-left: 5px; font-weight: 700; }

  /* --- LIGHTBOX (FULL SCREEN IMAGE) --- */
  #lightbox {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); z-index: 1000;
    justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s;
  }
  #lightbox.active { display: flex; opacity: 1; }
  #lightbox img { max-width: 90%; max-height: 90%; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
  .lightbox-close {
    position: absolute; top: 20px; right: 20px; color: white; font-size: 2rem;
    cursor: pointer; background: rgba(255,255,255,0.2); width: 50px; height: 50px;
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
  }

  /* --- SIDEBAR WIDGETS --- */
  .sidebar-widget {
    position: fixed; top: 100px; width: 260px;
    background: var(--card-bg); backdrop-filter: blur(10px);
    border: 1px solid var(--card-border); border-radius: 20px;
    padding: 15px; z-index: 90; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    display: flex; flex-direction: column; max-height: calc(100vh - 120px);
  }
  #calendar-widget { left: 20px; }
  #film-widget { right: 20px; }

  /* Calendar Styles */
  .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-weight: bold; font-size: 1rem; }
  .cal-nav-btn { background: transparent; border: none; color: var(--text-color); font-size: 1.2rem; cursor: pointer; padding: 0 5px; }
  .cal-days-header { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 0.75rem; opacity: 0.7; margin-bottom: 5px; }
  .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
  .cal-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; font-size: 0.85rem; position: relative; }
  .cal-day:hover { background: rgba(255,255,255,0.2); }
  .cal-day.today { border: 2px solid var(--accent-color); font-weight: bold; }
  .cal-day.has-event::after { content: ''; position: absolute; bottom: 3px; width: 4px; height: 4px; background: var(--accent-color); border-radius: 50%; }
  .cal-day.faded { opacity: 0.3; pointer-events: none; }

  /* Film Widget Styles */
  .film-input-group { display: flex; gap: 5px; margin-bottom: 10px; }
  .film-input { flex: 1; padding: 6px; border-radius: 8px; border: none; background: var(--input-bg); font-size: 0.8rem; color: #333; width: 100%; margin-bottom: 5px;}
  .film-list { display: flex; flex-direction: column; gap: 10px; overflow-y: auto; flex-grow: 1; padding-right: 5px; }
  .film-item { display: flex; gap: 10px; align-items: center; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 10px; }
  .film-poster { width: 40px; height: 60px; object-fit: cover; border-radius: 4px; background: #333; }
  .film-info { flex: 1; overflow: hidden; }
  .film-title { font-size: 0.85rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .film-rating { color: #ffd700; font-size: 0.8rem; }
  .film-expand-btn { margin-top: 10px; width: 100%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 5px; border-radius: 10px; cursor: pointer; font-size: 0.8rem; }
  
  /* --- MODALS --- */
  .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 500; align-items: center; justify-content: center; }
  .modal-overlay.active { display: flex; }
  .modal-content { background: var(--card-bg); border: 1px solid var(--card-border); padding: 25px; border-radius: 20px; width: 90%; max-width: 500px; position: relative; max-height: 80vh; overflow-y: auto; display: flex; flex-direction: column;}
  .close-modal-btn { position: absolute; top: 10px; right: 10px; background: red; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; }

  /* --- REACTION BUTTON --- */
  .reaction-btn {
    position: absolute; bottom: 10px; right: 10px;
    background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px);
    color: white; border: 1px solid rgba(255,255,255,0.3);
    border-radius: 20px; padding: 4px 10px;
    font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 4px;
    transition: transform 0.1s, background 0.2s, color 0.2s;
    z-index: 20;
  }
  .reaction-btn:hover { background: rgba(0,0,0,0.8); transform: scale(1.05); }
  .reaction-btn:active { transform: scale(0.95); }
  
  /* ACTIVE REACTION STATE (Liked) */
  .reaction-btn.active {
    background-color: var(--accent-color);
    color: #333;
    border-color: #fff;
    font-weight: bold;
    box-shadow: 0 0 10px var(--accent-color);
  }

  /* --- FLOATING ACTION BUTTONS --- */
  .fab-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; align-items: flex-end; z-index: 200; }
  .fab-btn { background: var(--btn-bg); color: var(--btn-text); padding: 12px 20px; border-radius: 30px; font-weight: bold; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; transition: transform 0.2s; display: flex; align-items: center; gap: 8px; }
  .fab-btn:hover { transform: scale(1.05); }
  
  /* Mobile Toggles */
  #mobile-cal-btn, #mobile-film-btn { display: none; }

  /* --- RESPONSIVE --- */
  @media (max-width: 1300px) {
    #calendar-widget, #film-widget { display: none; }
    #mobile-cal-btn, #mobile-film-btn { display: flex; }
    #currency-ticker { width: 90%; left: 5%; justify-content: center; top: 15px; }
    body { padding-top: 110px; }
  }
  
  /* --- CITY & GALLERY STYLES --- */
  h1 { font-size: 2rem; margin-bottom: 35px; text-shadow: 0 2px 6px rgba(0,0,0,0.3); text-align: center; }
  #cities { display: grid; grid-template-columns: repeat(auto-fit, minmax(270px, 1fr)); gap: 25px; width: 100%; max-width: 1100px; margin-bottom: 50px; }
  .city { position: relative; border-radius: 20px; overflow: hidden; background: var(--card-bg); backdrop-filter: blur(10px); border: 1px solid var(--card-border); display: flex; flex-direction: column; }
  .city img { width: 100%; height: 180px; object-fit: cover; background: #ddd; }
  .city-info { padding: 20px; text-align: center; background: rgba(0,0,0,0.1); flex-grow: 1; }
  .city h3 { margin-bottom: 6px; }
  
  /* Weather & Time Specific Styles */
  .city .time { font-size: 1.1rem; font-weight: bold; margin-bottom: 5px; }
  .city .temp { font-size: 1.2rem; font-weight: 600; margin-bottom: 2px; }
  .city .condition { font-size: 0.9rem; margin-top: 4px; font-weight: 500; opacity: 0.9; }

  .actions { margin-top: 15px; display: flex; justify-content: center; gap: 15px; }
  .action-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: var(--text-color); width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
  .file-input { display: none; }
  
  .content-section { width: 100%; max-width: 1100px; margin-top: 30px; background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 20px; padding: 20px; backdrop-filter: blur(5px); }
  .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--card-border); flex-wrap: wrap; gap: 10px; }
  .share-controls { display: flex; gap: 10px; flex-grow: 1; justify-content: flex-end; }
  .share-input { padding: 8px 12px; border-radius: 20px; border: none; background: var(--input-bg); color: #333; outline: none; font-size: 0.9rem; width: 200px; }
  .upload-btn { background: var(--btn-bg); color: var(--btn-text); border: none; padding: 8px 16px; border-radius: 20px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); white-space: nowrap; }
  .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
  .gallery-item { position: relative; border-radius: 15px; overflow: hidden; height: 150px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); background: rgba(0,0,0,0.2); transition: transform 0.2s; }
  .gallery-item:hover { transform: translateY(-5px); }
  .gallery-item img { width: 100%; height: 100%; object-fit: cover; cursor: pointer; }
  .link-item { text-decoration: none; color: white; display: block; height: 100%; position: relative; }
  .link-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); padding: 10px; padding-bottom: 35px; /* space for button */ font-size: 0.85rem; font-weight: 600; text-shadow: 0 1px 3px black; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .delete-btn { position: absolute; top: 5px; right: 5px; background: rgba(255,0,0,0.7); color: white; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; opacity: 0; transition: opacity 0.2s; z-index: 10; }
  .gallery-item:hover .delete-btn { opacity: 1; }

  /* Minesweeper CSS */
  #ms-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 300; justify-content: center; align-items: center; flex-direction: column; }
  #ms-modal.active { display: flex; }
  .ms-container { background: var(--card-bg); border: 1px solid var(--card-border); padding: 20px; border-radius: 20px; position: relative; max-width: 90%; display: flex; flex-direction: column; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
  .ms-grid { display: grid; grid-template-columns: repeat(9, 1fr); gap: 3px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 10px; }
  .ms-cell { width: 30px; height: 30px; background: var(--mine-bg); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; user-select: none; font-weight: bold; }
  .ms-cell.revealed { background: var(--mine-revealed); cursor: default; }
  .ms-cell.bomb { background: #ff5252; }
  .ms-cell.flag { color: #ffd700; }
  .ms-btn { background: var(--btn-bg); color: var(--btn-text); border: none; padding: 8px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; margin-top: 10px;}
</style>
</head>
<body>

<div id="lightbox">
    <div class="lightbox-close">√ó</div>
    <img src="" id="lightbox-img">
</div>

<div id="currency-ticker">
    <div class="currency-item" id="eur-usd">‚Ç¨1 = <span>...</span> USD</div>
    <div class="currency-item" id="eur-try">‚Ç¨1 = <span>...</span> TL</div>
    <div class="currency-item" id="gram-gold">ü•á Gram = <span>...</span> TL</div>
</div>

<div id="calendar-widget" class="sidebar-widget">
    <div class="cal-header">
        <button class="cal-nav-btn" id="cal-prev">‚ùÆ</button>
        <span id="cal-month-year">...</span>
        <button class="cal-nav-btn" id="cal-next">‚ùØ</button>
    </div>
    <div class="cal-days-header">
        <div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div><div>Su</div>
    </div>
    <div class="cal-grid" id="cal-grid"></div>
</div>

<div id="film-widget" class="sidebar-widget">
    <div class="cal-header"><span>üé¨ Watchlist</span></div>
    <div class="film-input-group">
        <input type="text" id="film-url" class="film-input" placeholder="Letterboxd/IMDb Link...">
    </div>
    <div class="film-input-group">
         <input type="number" id="film-rating" class="film-input" placeholder="Rating (0-5)" step="0.1" max="5">
         <button id="add-film-btn" class="upload-btn" style="min-width: 40px; padding: 0 10px;">+</button>
    </div>
    
    <div class="film-list" id="film-list-sidebar">
        <p style="text-align:center; opacity:0.6; font-size:0.8rem;">No films yet.</p>
    </div>
    <button class="film-expand-btn" id="expand-films-btn">Expand List ‚§¢</button>
</div>

<div id="event-modal" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal-btn" id="close-event-modal">√ó</button>
        <h3 id="event-date-title" style="margin-bottom:15px; color:inherit;">Date</h3>
        <div id="event-list-container" style="margin-bottom:15px;"></div>
        <div style="display:flex; gap:5px;">
            <input type="time" id="event-time" class="share-input" style="width: 80px;">
            <input type="text" id="event-desc" class="share-input" placeholder="Description..." style="flex:1;">
            <button id="add-event-btn" class="upload-btn">+</button>
        </div>
    </div>
</div>

<div id="film-modal" class="modal-overlay">
    <div class="modal-content" style="max-height: 90vh;">
        <button class="close-modal-btn" id="close-film-modal">√ó</button>
        <h3>üé¨ All Films</h3>
        <div class="film-list" id="film-list-full" style="margin-top:15px;"></div>
    </div>
</div>

<div class="fab-container">
    <button id="ms-trigger-btn" class="fab-btn">üí£ Oyna (Rekor: --s)</button>
    <button id="mobile-cal-btn" class="fab-btn">üìÖ Takvim</button>
    <button id="mobile-film-btn" class="fab-btn">üé¨ Filmler</button>
</div>

<div id="ms-modal">
    <div class="ms-container">
        <button class="close-modal-btn" style="top:-15px; right:-15px;" id="ms-close-btn">√ó</button>
        <div class="ms-header" style="width:100%; display:flex; justify-content:space-between; margin-bottom:10px; font-weight:bold;">
            <span>üí£ <span id="ms-mines-left">10</span></span>
            <span>‚è±Ô∏è <span id="ms-timer">0</span>s</span>
        </div>
        <div class="ms-grid" id="ms-grid"></div>
        <div style="text-align:center; margin-top:15px;">
            <div style="font-size: 0.8rem; margin-bottom: 5px; opacity: 0.8;">Best: <span id="ms-best-score-display">--</span>s</div>
            <button class="ms-btn" id="ms-restart">New Game</button>
        </div>
    </div>
</div>

<button id="theme-toggle" class="theme-toggle" title="Toggle Dark Mode">üåô</button>

<h1>üåç Fortunately</h1>

<div id="cities"></div>

<div class="content-section" id="share-section">
    <div class="section-header">
        <h2>üîó Shared Links</h2>
        <div class="share-controls">
            <input type="text" id="link-title" class="share-input" placeholder="Title">
            <input type="text" id="link-url" class="share-input" placeholder="Paste Link...">
            <button id="add-link-btn" class="upload-btn">‚ûï Add</button>
        </div>
    </div>
    <div id="link-gallery" class="gallery-grid"></div>
</div>

<div class="content-section" id="food-section">
    <div class="section-header">
        <h2>üì∏ Local Tastes</h2>
        <label class="upload-btn">
            üì∑ Upload
            <input type="file" id="food-input" class="file-input" accept="image/*">
        </label>
    </div>
    <div id="food-gallery" class="gallery-grid"></div>
</div>

<div class="content-section" id="drink-section">
    <div class="section-header">
        <h2>üçπ Drinks</h2>
        <label class="upload-btn" style="background-color: #ff9800; color: white;">
            üç∑ Upload
            <input type="file" id="drink-input" class="file-input" accept="image/*">
        </label>
    </div>
    <div id="drink-gallery" class="gallery-grid"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, onValue, set, push, remove, runTransaction, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCUTBQ5oIgF1GEU8rGj9Mxqz7a2g1Ecswk",
    authDomain: "timetemp-9b1a5.firebaseapp.com",
    databaseURL: "https://timetemp-9b1a5-default-rtdb.firebaseio.com/",
    projectId: "timetemp-9b1a5",
    storageBucket: "timetemp-9b1a5.firebasestorage.app",
    messagingSenderId: "580366684921",
    appId: "1:580366684921:web:2133261bcfccc0a21a0828",
    measurementId: "G-THB6G2TWEV"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);


  // --- Theme ---
  const toggleBtn = document.getElementById("theme-toggle");
  if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("dark-mode");
    toggleBtn.textContent = "‚òÄÔ∏è";
  }
  toggleBtn.addEventListener("click", () => {
    document.body.classList.toggle("dark-mode");
    const isDark = document.body.classList.contains("dark-mode");
    toggleBtn.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
    localStorage.setItem("theme", isDark ? "dark" : "light");
  });

  // --- Lightbox Logic ---
  const lightbox = document.getElementById("lightbox");
  const lightboxImg = document.getElementById("lightbox-img");
  const lightboxClose = document.querySelector(".lightbox-close");

  function openLightbox(src) {
      lightboxImg.src = src;
      lightbox.classList.add("active");
  }
  lightboxClose.addEventListener("click", () => lightbox.classList.remove("active"));
  lightbox.addEventListener("click", (e) => {
      if(e.target === lightbox) lightbox.classList.remove("active");
  });

  // --- Reaction Logic (Toggle: Like/Unlike per user) ---
  function toggleReaction(path, itemId) {
      const storageKey = "liked_" + itemId;
      const isLiked = localStorage.getItem(storageKey);

      const reactionRef = ref(db, path);
      runTransaction(reactionRef, (currentVal) => {
          if (isLiked) {
              // Unlike
              const newVal = (currentVal || 0) - 1;
              return newVal < 0 ? 0 : newVal;
          } else {
              // Like
              return (currentVal || 0) + 1;
          }
      }).then(() => {
          if (isLiked) localStorage.removeItem(storageKey);
          else localStorage.setItem(storageKey, "true");
      });
  }

  function formatReactionCount(count) {
      if (!count) return "";
      return count > 8 ? "8+" : count;
  }

  // --- Films Logic ---
  async function fetchFilmData(url) {
      try {
        const response = await fetch(`https://api.microlink.io/?url=${encodeURIComponent(url)}`);
        const data = await response.json();
        if (data.status === 'success') {
            return {
                title: data.data.title || "Unknown Film",
                img: data.data.image ? data.data.image.url : "https://via.placeholder.com/150",
            };
        }
      } catch (e) { console.error(e); }
      return { title: "New Movie", img: "https://via.placeholder.com/150" };
  }

  const addFilmBtn = document.getElementById("add-film-btn");
  addFilmBtn.addEventListener("click", async () => {
      const urlIn = document.getElementById("film-url");
      const ratingIn = document.getElementById("film-rating");
      const url = urlIn.value.trim();
      
      if(url) {
          addFilmBtn.textContent = "‚è≥";
          let finalUrl = url.startsWith("http") ? url : "https://" + url;
          const meta = await fetchFilmData(finalUrl);
          
          push(ref(db, "films"), {
              url: finalUrl,
              title: meta.title,
              img: meta.img,
              rating: ratingIn.value || "?",
              timestamp: Date.now()
          });
          
          urlIn.value = ""; ratingIn.value = ""; addFilmBtn.textContent = "+";
      }
  });

  // Render Films
  onValue(ref(db, "films"), snap => {
      const data = snap.val();
      const sidebarList = document.getElementById("film-list-sidebar");
      const fullList = document.getElementById("film-list-full");
      sidebarList.innerHTML = ""; fullList.innerHTML = "";
      
      if(!data) {
          sidebarList.innerHTML = '<p style="text-align:center;opacity:0.6;">No films.</p>';
          return;
      }
      
      const films = Object.keys(data).map(k => ({ id: k, ...data[k] })).sort((a,b) => b.timestamp - a.timestamp);
      films.slice(0, 5).forEach(f => sidebarList.appendChild(createFilmElement(f)));
      films.forEach(f => fullList.appendChild(createFilmElement(f, true)));
  });

  function createFilmElement(film, canDelete = false) {
      const div = document.createElement("div");
      div.className = "film-item";
      div.innerHTML = `
        <img src="${film.img}" class="film-poster">
        <div class="film-info">
            <div class="film-title"><a href="${film.url}" target="_blank" style="color:inherit; text-decoration:none;">${film.title}</a></div>
            <div class="film-rating">‚≠ê ${film.rating}</div>
        </div>
        ${canDelete ? '<button class="delete-film-btn" style="background:red; color:white; border:none; border-radius:5px; cursor:pointer;">√ó</button>' : ''}
      `;
      if(canDelete) {
          div.querySelector(".delete-film-btn").addEventListener("click", () => {
              if(confirm("Delete film?")) remove(ref(db, `films/${film.id}`));
          });
      }
      return div;
  }

  // Film Modal
  const filmModal = document.getElementById("film-modal");
  document.getElementById("expand-films-btn").addEventListener("click", () => filmModal.classList.add("active"));
  document.getElementById("close-film-modal").addEventListener("click", () => filmModal.classList.remove("active"));
  document.getElementById("mobile-film-btn").addEventListener("click", () => filmModal.classList.add("active"));

  // --- Calendar Logic ---
  const calGrid = document.getElementById("cal-grid");
  const calMonthYear = document.getElementById("cal-month-year");
  const eventModal = document.getElementById("event-modal");
  let currentDate = new Date(); let selectedDateKey = null; let eventsData = {};

  onValue(ref(db, "calendar_events"), snap => {
      eventsData = snap.val() || {}; renderCalendar();
      if(selectedDateKey && eventModal.classList.contains("active")) renderEventList(selectedDateKey);
  });

  function renderCalendar() {
      const year = currentDate.getFullYear(); const month = currentDate.getMonth();
      calMonthYear.textContent = new Date(year, month).toLocaleString('default', { month: 'long', year: 'numeric' });
      calGrid.innerHTML = "";
      const firstDay = new Date(year, month, 1).getDay();
      const startDayIndex = (firstDay === 0 ? 6 : firstDay - 1);
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      for(let i=0; i<startDayIndex; i++) calGrid.appendChild(Object.assign(document.createElement("div"), {className: "cal-day faded"}));
      
      for(let d=1; d<=daysInMonth; d++) {
          const div = document.createElement("div"); div.className = "cal-day"; div.textContent = d;
          const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          if(d === new Date().getDate() && month === new Date().getMonth()) div.classList.add("today");
          if(eventsData[dateKey]) div.classList.add("has-event");
          div.addEventListener("click", () => {
              selectedDateKey = dateKey;
              document.getElementById("event-date-title").textContent = new Date(dateKey).toDateString();
              renderEventList(dateKey); eventModal.classList.add("active");
          });
          calGrid.appendChild(div);
      }
  }

  function renderEventList(dateKey) {
      const container = document.getElementById("event-list-container"); container.innerHTML = "";
      const events = eventsData[dateKey];
      if(!events) { container.innerHTML = '<p style="opacity:0.6;">No events.</p>'; return; }
      Object.keys(events).forEach(key => {
          const ev = events[key];
          const div = document.createElement("div");
          div.style.cssText = "background:rgba(0,0,0,0.1); padding:5px; margin-bottom:5px; border-radius:5px; display:flex; justify-content:space-between;";
          div.innerHTML = `<span><b>${ev.time}</b> ${ev.desc}</span><span style="color:red; cursor:pointer;" class="del-ev">√ó</span>`;
          div.querySelector(".del-ev").addEventListener("click", () => remove(ref(db, `calendar_events/${dateKey}/${key}`)));
          container.appendChild(div);
      });
  }

  document.getElementById("add-event-btn").addEventListener("click", () => {
      const time = document.getElementById("event-time").value;
      const desc = document.getElementById("event-desc").value.trim();
      if(desc && selectedDateKey) {
          push(ref(db, `calendar_events/${selectedDateKey}`), { time, desc });
          document.getElementById("event-desc").value = "";
      }
  });

  document.getElementById("close-event-modal").addEventListener("click", () => eventModal.classList.remove("active"));
  document.getElementById("cal-prev").addEventListener("click", () => { currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
  document.getElementById("cal-next").addEventListener("click", () => { currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });
  
  const calendarWidget = document.getElementById("calendar-widget");
  document.getElementById("mobile-cal-btn").addEventListener("click", () => {
      if(calendarWidget.style.display === "flex") {
           calendarWidget.style.display = "none";
      } else {
           calendarWidget.style.display = "flex";
           calendarWidget.style.top = "50%"; calendarWidget.style.left = "50%"; calendarWidget.style.transform = "translate(-50%, -50%)";
      }
  });
  renderCalendar();

  // --- Minesweeper ---
  const msTriggerBtn = document.getElementById("ms-trigger-btn");
  const msModal = document.getElementById("ms-modal");
  const msCloseBtn = document.getElementById("ms-close-btn");
  const msGrid = document.getElementById("ms-grid");
  const msMinesLeftEl = document.getElementById("ms-mines-left");
  const msTimerEl = document.getElementById("ms-timer");
  const msRestartBtn = document.getElementById("ms-restart");
  const msBestScoreDisplay = document.getElementById("ms-best-score-display");

  msTriggerBtn.addEventListener("click", () => msModal.classList.add("active"));
  msCloseBtn.addEventListener("click", () => msModal.classList.remove("active"));

  const MS_SIZE = 9; const MS_MINES = 10;
  let msBoard = [], msGameOver = false, msTime = 0, msTimerInterval = null, msStarted = false, msMinesMarked = 0;
  
  onValue(ref(db, "minesweeper/highscore"), snap => {
    const val = snap.val();
    msTriggerBtn.textContent = `üí£ Oyna (Rekor: ${val ? val : "--"}s)`;
    msBestScoreDisplay.textContent = val ? val : "--";
  });

  function initMinesweeper() {
      msGameOver = false; msStarted = false; msTime = 0; msMinesMarked = 0; msBoard = [];
      clearInterval(msTimerInterval); msTimerEl.textContent = "0"; msMinesLeftEl.textContent = MS_MINES; msGrid.innerHTML = "";
      for(let i=0; i<MS_SIZE*MS_SIZE; i++) {
          const cell = document.createElement("div"); cell.className = "ms-cell"; cell.dataset.id = i;
          cell.addEventListener("click", () => handleClick(i));
          cell.addEventListener("contextmenu", (e) => { e.preventDefault(); handleRightClick(i); });
          msGrid.appendChild(cell);
          msBoard.push({ isMine: false, revealed: false, flagged: false, neighbors: 0 });
      }
      let minesPlaced = 0;
      while(minesPlaced < MS_MINES) {
          const idx = Math.floor(Math.random() * (MS_SIZE*MS_SIZE));
          if(!msBoard[idx].isMine) { msBoard[idx].isMine = true; minesPlaced++; }
      }
      for(let i=0; i<MS_SIZE*MS_SIZE; i++) {
          if(msBoard[i].isMine) continue;
          let count = 0; const r = Math.floor(i / MS_SIZE); const c = i % MS_SIZE;
          for(let dr=-1; dr<=1; dr++) { for(let dc=-1; dc<=1; dc++) { const nr = r + dr; const nc = c + dc; if(nr>=0 && nr<MS_SIZE && nc>=0 && nc<MS_SIZE) { if(msBoard[nr * MS_SIZE + nc].isMine) count++; } } }
          msBoard[i].neighbors = count;
      }
  }
  
  function handleClick(idx) {
      if(msGameOver || msBoard[idx].flagged || msBoard[idx].revealed) return;
      if(!msStarted) { msStarted = true; msTimerInterval = setInterval(() => { msTime++; msTimerEl.textContent = msTime; }, 1000); }
      if(msBoard[idx].isMine) { msGameOver = true; clearInterval(msTimerInterval); msBoard.forEach((c, i) => { if(c.isMine) { msGrid.children[i].classList.add("bomb"); msGrid.children[i].textContent = "üí£"; } }); alert("Game Over!"); } 
      else { reveal(idx); checkWin(); }
  }
  
  function handleRightClick(idx) {
      if(msGameOver || msBoard[idx].revealed) return;
      const cell = msGrid.children[idx];
      if(msBoard[idx].flagged) { msBoard[idx].flagged = false; cell.classList.remove("flag"); cell.textContent = ""; msMinesMarked--; } 
      else { msBoard[idx].flagged = true; cell.classList.add("flag"); cell.textContent = "üö©"; msMinesMarked++; }
      msMinesLeftEl.textContent = MS_MINES - msMinesMarked;
  }
  
  function reveal(idx) {
      if(msBoard[idx].revealed || msBoard[idx].flagged) return;
      msBoard[idx].revealed = true; const cell = msGrid.children[idx]; cell.classList.add("revealed");
      if(msBoard[idx].neighbors > 0) {
          cell.textContent = msBoard[idx].neighbors;
          const colors = ["#0000ff", "#008000", "#ff0000", "#000080"];
          cell.style.color = colors[msBoard[idx].neighbors - 1] || "black";
      } else {
          const r = Math.floor(idx / MS_SIZE); const c = idx % MS_SIZE;
          for(let dr=-1; dr<=1; dr++) { for(let dc=-1; dc<=1; dc++) { const nr = r + dr; const nc = c + dc; if(nr>=0 && nr<MS_SIZE && nc>=0 && nc<MS_SIZE) reveal(nr * MS_SIZE + nc); } }
      }
  }
  
  function checkWin() { let safe = 0; msBoard.forEach(c => { if(!c.isMine && !c.revealed) safe++; }); if(safe === 0) {
      msGameOver = true; clearInterval(msTimerInterval);
      const currentBest = parseInt(msBestScoreDisplay.textContent) || 9999;
      if(msTime < currentBest) { set(ref(db, "minesweeper/highscore"), msTime); alert(`New High Score: ${msTime}s!`); } else { alert("You Won!"); }
  }}
  msRestartBtn.addEventListener("click", initMinesweeper); initMinesweeper();

  // --- CITIES & WEATHER LOGIC ---
  const cities = [
    { name: "Istanbul", timezone: "Europe/Istanbul", lat: 41.0082, lon: 28.9784, img: "https://images.unsplash.com/photo-1524231757912-21f4fe3a7200?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" },
    { name: "Ankara", timezone: "Europe/Istanbul", lat: 39.9334, lon: 32.8597, img: "https://pbs.twimg.com/media/G3ALijdXcAA4cI4?format=jpg&name=900x900" },
    { name: "Munich", timezone: "Europe/Berlin", lat: 48.1351, lon: 11.5820, img: "https://tallgirlbigworld.com/wp-content/uploads/2021/10/Marienplatz-Munich.jpg" },
    { name: "Boston", timezone: "America/New_York", lat: 42.3601, lon: -71.0589, img: "https://www.travelandleisure.com/thmb/OxTfa-TTiGTLm_jUvSw2egK7eSs=/750x0/filters:no_upscale():max_bytes(150000):strip_icc():format(webp)/boston-massachusetts-BOSTONTG0221-719aef2eeb1c4929b6c839715e34a69e.jpg" },
    { name: "Leipzig", timezone: "Europe/Berlin", lat: 51.3397, lon: 12.3731, img: "https://img.ecmaps.de/remote/.webp?url=https%3A%2F%2Fdam.destination.one%2F2514134%2Fe9e1b4e85a01247d6242aa96e7a67f36d1db43aacb3a2b004410b3e8bfd920cb%2Fyour-meeting-conference-in-leipzig-augustusplatz-with-opera-gewandhaus-city-hochhaus.jpg&scale=both&mode=crop&quality=90&width=751&height=563" },
    { name: "Tucson", timezone: "America/Phoenix", lat: 32.2226, lon: -110.9747, img: "https://wnpa.org/sites/default/files/styles/scale_1920/public/2025-04/qUmhXeM1COMBFlSa.webp?itok=sFd5Ijpq" },
    { name: "San Diego", timezone: "America/Los_Angeles", lat: 32.7157, lon: -117.1611, img: "https://specials-images.forbesimg.com/dam/imageserve/1120536785/960x0.jpg?fit=scale" }
  ];

  const weatherDescriptions = { 0: "‚òÄÔ∏è Clear", 1: "üå§ Mainly clear", 2: "‚õÖ Partly cloudy", 3: "‚òÅÔ∏è Overcast", 45: "üå´ Fog", 51: "üå¶ Drizzle", 61: "üå¶ Rain", 63: "üåß Rain", 71: "üå® Snow", 80: "üåß Showers", 95: "‚õà Thunderstorm" };

  const container = document.getElementById("cities");
  cities.forEach(city => {
    const div = document.createElement("div"); div.className = "city";
    div.innerHTML = `
        <img src="${city.img}">
        <div class="city-info">
            <h3>${city.name}</h3>
            <p class="time">--:--</p>
            <p class="temp">-- ¬∞C</p>
            <p class="condition">--</p>
            <div class="actions">
                <label class="action-btn">üì∑ <input type="file" class="file-input" accept="image/*"></label>
            </div>
        </div>
    `;
    container.appendChild(div);
    city.element = div;
    div.querySelector(".file-input").addEventListener("change", (e) => { if(e.target.files[0]) {
        const reader = new FileReader(); reader.onload = (evt) => {
            const img = new Image(); img.onload = () => {
                const canvas = document.createElement("canvas"); const ctx = canvas.getContext("2d");
                canvas.width = img.width > 800 ? 800 : img.width; canvas.height = img.width > 800 ? img.height * (800/img.width) : img.height;
                ctx.drawImage(img,0,0,canvas.width,canvas.height); set(ref(db, "cities/" + city.name + "/img"), canvas.toDataURL("image/jpeg", 0.7));
            }; img.src = evt.target.result;
        }; reader.readAsDataURL(e.target.files[0]);
    }});
    onValue(ref(db, "cities/" + city.name + "/img"), snap => { if(snap.val()) div.querySelector("img").src = snap.val(); });
  });

  async function updateWeather() {
    for (const city of cities) {
      try {
        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current_weather=true`);
        const data = await res.json();
        if(city.element) {
            city.element.querySelector(".temp").textContent = `${data.current_weather.temperature} ¬∞C`;
            city.element.querySelector(".condition").textContent = weatherDescriptions[data.current_weather.weathercode] || "Unknown";
        }
      } catch (e) {}
    }
  }

  function updateTime() {
    const now = new Date();
    cities.forEach(city => {
      if(city.element) city.element.querySelector(".time").textContent = now.toLocaleTimeString("en-GB", { timeZone: city.timezone, hour: "2-digit", minute: "2-digit" });
    });
  }

  // --- Helper for Uploads & Reactions ---
  function setupUpload(inputId, dbPath, galleryId, emoji) {
      document.getElementById(inputId).addEventListener("change", (e) => {
        if (e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement("canvas");
                    const ctx = canvas.getContext("2d");
                    const maxWidth = 800; let width = img.width; let height = img.height;
                    if (width > maxWidth) { height = height * (maxWidth / width); width = maxWidth; }
                    canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height);
                    push(ref(db, dbPath), { url: canvas.toDataURL("image/jpeg", 0.7), reactions: 0 });
                };
                img.src = evt.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        }
      });

      onValue(ref(db, dbPath), snap => {
        const gallery = document.getElementById(galleryId); gallery.innerHTML = "";
        const data = snap.val();
        if(data) Object.keys(data).reverse().forEach(key => {
            const item = data[key];
            const div = document.createElement("div"); div.className = "gallery-item";
            
            const imgEl = document.createElement("img");
            imgEl.src = item.url;
            imgEl.addEventListener("click", () => openLightbox(item.url));
            
            const countStr = formatReactionCount(item.reactions);
            const reactBtn = document.createElement("button");
            reactBtn.className = "reaction-btn";
            reactBtn.innerHTML = `${emoji} ${countStr}`;
            
            // Check LocalStorage for active state
            if (localStorage.getItem("liked_" + key)) reactBtn.classList.add("active");

            reactBtn.addEventListener("click", (e) => {
                e.stopPropagation(); 
                toggleReaction(`${dbPath}/${key}/reactions`, key);
            });

            const delBtn = document.createElement("button");
            delBtn.className = "delete-btn"; delBtn.innerHTML = "üóëÔ∏è";
            delBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                if(confirm("Delete?")) remove(ref(db, `${dbPath}/${key}`));
            });

            div.appendChild(imgEl);
            div.appendChild(reactBtn);
            div.appendChild(delBtn);
            gallery.appendChild(div);
        });
      });
  }

  setupUpload("food-input", "foods", "food-gallery", "üòã");
  setupUpload("drink-input", "drinks", "drink-gallery", "üòã");

  // Shared Links Logic
  document.getElementById("add-link-btn").addEventListener("click", async () => {
      const urlIn = document.getElementById("link-url"), titleIn = document.getElementById("link-title");
      if (urlIn.value.trim()) {
          const btn = document.getElementById("add-link-btn"); btn.textContent = "‚è≥";
          let finalUrl = urlIn.value.trim().startsWith("http") ? urlIn.value.trim() : "https://" + urlIn.value.trim();
          let img = "https://cdn-icons-png.flaticon.com/512/1006/1006771.png";
          try {
             const res = await fetch(`https://api.microlink.io/?url=${encodeURIComponent(finalUrl)}`);
             const d = await res.json();
             if(d.status === 'success' && d.data.image) img = d.data.image.url;
          } catch {}
          
          push(ref(db, "links"), { url: finalUrl, title: titleIn.value.trim() || new URL(finalUrl).hostname, img: img, timestamp: Date.now(), reactions: 0 });
          urlIn.value = ""; titleIn.value = ""; btn.textContent = "‚ûï Add";
      }
  });

  onValue(ref(db, "links"), snap => {
    const gallery = document.getElementById("link-gallery"); gallery.innerHTML = "";
    const data = snap.val();
    if (!data) return;
    Object.keys(data).reverse().forEach(key => { 
        const item = data[key]; 
        const div = document.createElement("div"); div.className = "gallery-item";
        const countStr = formatReactionCount(item.reactions);
        
        // Active Class Check
        const activeClass = localStorage.getItem("liked_" + key) ? "active" : "";

        div.innerHTML = `
            <a href="${item.url}" target="_blank" class="link-item">
                <img src="${item.img}">
                <div class="link-overlay">${item.title}</div>
            </a>
            <button class="reaction-btn ${activeClass}" id="react-${key}">üòÇ ${countStr}</button>
            <button class="delete-btn" id="del-${key}">üóëÔ∏è</button>
        `;
        div.querySelector(`#react-${key}`).addEventListener("click", (e) => { e.preventDefault(); toggleReaction(`links/${key}/reactions`, key); });
        div.querySelector(`#del-${key}`).addEventListener("click", (e) => { e.preventDefault(); if(confirm("Delete?")) remove(ref(db, "links/" + key)); });
        gallery.appendChild(div);
    });
  });

  async function updateCurrency() {
    try {
        const res = await fetch("https://api.frankfurter.app/latest?from=EUR&to=USD,TRY");
        const data = await res.json();
        const usdRate = data.rates.USD; const tryRate = data.rates.TRY; const usdToTry = tryRate / usdRate; 
        document.querySelector("#eur-usd span").textContent = usdRate.toFixed(2);
        document.querySelector("#eur-try span").textContent = tryRate.toFixed(2);
        const goldRes = await fetch("https://api.gold-api.com/price/XAU");
        const goldData = await goldRes.json();
        if (goldData.price) document.querySelector("#gram-gold span").textContent = ((goldData.price / 31.1035) * usdToTry).toFixed(0);
    } catch {}
  }
  
  updateTime(); setInterval(updateTime, 1000);
  updateWeather(); setInterval(updateWeather, 600000);
  updateCurrency(); setInterval(updateCurrency, 3600000);

</script>
</body>
</html>
