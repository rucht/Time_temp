<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Fortunately</title>

<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  
  :root {
    --bg-gradient: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
    --card-bg: rgba(255, 255, 255, 0.15);
    --text-color: #fff;
    --currency-num-color: #003366; 
    --card-border: rgba(255, 255, 255, 0.3);
    --btn-bg: #ffeb3b;
    --btn-text: #333;
    --input-bg: rgba(255, 255, 255, 0.8);
  }

  body {
    font-family: "Poppins", sans-serif;
    background: var(--bg-gradient);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    color: var(--text-color);
    transition: background 0.5s ease;
    padding-top: 80px; /* Space for top elements */
  }

  /* --- DARK MODE STYLES --- */
  body.dark-mode {
    --bg-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    --card-bg: rgba(0, 0, 0, 0.5);
    --text-color: #e0e0e0;
    --currency-num-color: #4db8ff; 
    --card-border: rgba(255, 255, 255, 0.1);
    --btn-bg: #4db8ff;
    --btn-text: #000;
    --input-bg: rgba(30, 30, 30, 0.8);
  }

  /* --- TOP RIGHT TOGGLE BUTTON --- */
  .theme-toggle {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.4);
    color: #fff;
    font-size: 1.5rem;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    z-index: 100;
  }
  .theme-toggle:hover { background: rgba(255, 255, 255, 0.4); transform: scale(1.1); }

  /* --- CURRENCY TICKER (Moved & Resized) --- */
  #currency-ticker {
    position: absolute;
    top: 25px;
    left: 20px;
    background: var(--card-bg);
    backdrop-filter: blur(5px);
    border: 1px solid var(--card-border);
    border-radius: 20px;
    padding: 8px 15px;
    display: flex;
    gap: 15px;
    font-weight: 500;
    font-size: 0.85rem; /* Smaller font */
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: background 0.3s;
    z-index: 99;
  }
  .currency-item span { 
    color: var(--currency-num-color); 
    margin-left: 5px; 
    font-weight: 700;
  }

  h1 { font-size: 2rem; margin-bottom: 35px; text-shadow: 0 2px 6px rgba(0,0,0,0.3); text-align: center; }
  
  /* --- CITIES GRID --- */
  #cities {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(270px, 1fr));
    gap: 25px;
    width: 100%;
    max-width: 1100px;
    margin-bottom: 50px;
  }
  .city {
    position: relative;
    border-radius: 20px;
    overflow: hidden;
    background: var(--card-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--card-border);
    transition: transform 0.3s, background 0.3s;
    display: flex;
    flex-direction: column;
  }
  .city img { width: 100%; height: 180px; object-fit: cover; background: #ddd; }
  .city-info { padding: 20px; text-align: center; background: rgba(0,0,0,0.1); flex-grow: 1; }
  .city h3 { margin-bottom: 6px; }
  .city .condition { font-size: 0.9rem; margin-top: 4px; font-weight: 500; opacity: 0.9; }
  
  /* --- PHOTO ACTIONS --- */
  .actions {
    margin-top: 15px;
    display: flex;
    justify-content: center;
    gap: 15px;
  }
  .action-btn {
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.4);
    color: var(--text-color);
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
    font-size: 1.1rem;
  }
  .action-btn:hover { background: rgba(255,255,255,0.4); }
  .file-input { display: none; }

  /* --- SHARED SECTION STYLES --- */
  .content-section {
    width: 100%;
    max-width: 1100px;
    margin-top: 30px;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 20px;
    padding: 20px;
    backdrop-filter: blur(5px);
  }
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--card-border);
    flex-wrap: wrap;
    gap: 10px;
  }
  
  /* Inputs for Sharing */
  .share-controls {
    display: flex;
    gap: 10px;
    flex-grow: 1;
    justify-content: flex-end;
  }
  .share-input {
    padding: 8px 12px;
    border-radius: 20px;
    border: none;
    font-family: inherit;
    background: var(--input-bg);
    color: #333;
    outline: none;
    font-size: 0.9rem;
    width: 200px;
  }
  body.dark-mode .share-input { color: #fff; }

  .upload-btn {
    background: var(--btn-bg);
    color: var(--btn-text);
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    transition: transform 0.2s;
    white-space: nowrap;
  }
  .upload-btn:hover { transform: scale(1.05); }

  /* Galleries (Food, Drinks, Links) */
  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
  }
  .gallery-item {
    position: relative;
    border-radius: 15px;
    overflow: hidden;
    height: 150px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    background: rgba(0,0,0,0.2);
    transition: transform 0.2s;
  }
  .gallery-item:hover { transform: translateY(-5px); }
  
  .gallery-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Link Specific Styles */
  .link-item {
    text-decoration: none;
    color: white;
    display: block;
    height: 100%;
    position: relative;
  }
  .link-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
    padding: 10px;
    font-size: 0.85rem;
    font-weight: 600;
    text-shadow: 0 1px 3px black;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .delete-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(255,0,0,0.7);
    color: white;
    border: none;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 10;
  }
  .gallery-item:hover .delete-btn { opacity: 1; }

</style>
</head>
<body>

<div id="currency-ticker">
    <div class="currency-item" id="eur-usd">‚Ç¨1 = <span>...</span> USD</div>
    <div class="currency-item" id="eur-try">‚Ç¨1 = <span>...</span> TL</div>
</div>

<button id="theme-toggle" class="theme-toggle" title="Toggle Dark Mode">üåô</button>

<h1>üåç Fortunately</h1>

<div id="cities"></div>

<div class="content-section" id="share-section">
    <div class="section-header">
        <h2>üîó Shared Links</h2>
        <div class="share-controls">
            <input type="text" id="link-title" class="share-input" placeholder="Title (e.g. Funny Cat)">
            <input type="text" id="link-url" class="share-input" placeholder="Paste Link Here...">
            <button id="add-link-btn" class="upload-btn">‚ûï Add</button>
        </div>
    </div>
    <div id="link-gallery" class="gallery-grid">
        <p style="grid-column: 1/-1; text-align: center; opacity: 0.7;">No shared links yet.</p>
    </div>
</div>

<div class="content-section" id="food-section">
    <div class="section-header">
        <h2>üì∏ Local Tastes</h2>
        <label class="upload-btn">
            üì∑ Upload Food
            <input type="file" id="food-input" class="file-input" accept="image/*">
        </label>
    </div>
    <div id="food-gallery" class="gallery-grid">
        <p style="grid-column: 1/-1; text-align: center; opacity: 0.7;">No food photos yet.</p>
    </div>
</div>

<div class="content-section" id="drink-section">
    <div class="section-header">
        <h2>üçπ Drinks</h2>
        <label class="upload-btn" style="background-color: #ff9800; color: white;">
            üç∑ Upload Drink
            <input type="file" id="drink-input" class="file-input" accept="image/*">
        </label>
    </div>
    <div id="drink-gallery" class="gallery-grid">
        <p style="grid-column: 1/-1; text-align: center; opacity: 0.7;">No drink photos yet.</p>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, onValue, set, push, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCUTBQ5oIgF1GEU8rGj9Mxqz7a2g1Ecswk",
    authDomain: "timetemp-9b1a5.firebaseapp.com",
    databaseURL: "https://timetemp-9b1a5-default-rtdb.firebaseio.com/",
    projectId: "timetemp-9b1a5",
    storageBucket: "timetemp-9b1a5.firebasestorage.app",
    messagingSenderId: "580366684921",
    appId: "1:580366684921:web:2133261bcfccc0a21a0828",
    measurementId: "G-THB6G2TWEV"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // --- Dark Mode Logic ---
  const toggleBtn = document.getElementById("theme-toggle");
  
  if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("dark-mode");
    toggleBtn.textContent = "‚òÄÔ∏è";
  }

  toggleBtn.addEventListener("click", () => {
    document.body.classList.toggle("dark-mode");
    const isDark = document.body.classList.contains("dark-mode");
    toggleBtn.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
    localStorage.setItem("theme", isDark ? "dark" : "light");
  });

  const cities = [
    { name: "Istanbul", timezone: "Europe/Istanbul", lat: 41.0082, lon: 28.9784, img: "https://images.unsplash.com/photo-1524231757912-21f4fe3a7200?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" },
    { name: "Ankara", timezone: "Europe/Istanbul", lat: 39.9334, lon: 32.8597, img: "https://pbs.twimg.com/media/G3ALijdXcAA4cI4?format=jpg&name=900x900" },
    { name: "Munich", timezone: "Europe/Berlin", lat: 48.1351, lon: 11.5820, img: "https://tallgirlbigworld.com/wp-content/uploads/2021/10/Marienplatz-Munich.jpg" },
    { name: "Boston", timezone: "America/New_York", lat: 42.3601, lon: -71.0589, img: "https://www.travelandleisure.com/thmb/OxTfa-TTiGTLm_jUvSw2egK7eSs=/750x0/filters:no_upscale():max_bytes(150000):strip_icc():format(webp)/boston-massachusetts-BOSTONTG0221-719aef2eeb1c4929b6c839715e34a69e.jpg" },
    { name: "Leipzig", timezone: "Europe/Berlin", lat: 51.3397, lon: 12.3731, img: "https://img.ecmaps.de/remote/.webp?url=https%3A%2F%2Fdam.destination.one%2F2514134%2Fe9e1b4e85a01247d6242aa96e7a67f36d1db43aacb3a2b004410b3e8bfd920cb%2Fyour-meeting-conference-in-leipzig-augustusplatz-with-opera-gewandhaus-city-hochhaus.jpg&scale=both&mode=crop&quality=90&width=751&height=563" },
    { name: "Tucson", timezone: "America/Phoenix", lat: 32.2226, lon: -110.9747, img: "https://wnpa.org/sites/default/files/styles/scale_1920/public/2025-04/qUmhXeM1COMBFlSa.webp?itok=sFd5Ijpq" },
    { name: "San Diego", timezone: "America/Los_Angeles", lat: 32.7157, lon: -117.1611, img: "https://specials-images.forbesimg.com/dam/imageserve/1120536785/960x0.jpg?fit=scale" }
  ];

  const weatherDescriptions = {
    0: "‚òÄÔ∏è Clear", 1: "üå§ Mainly clear", 2: "‚õÖ Partly cloudy", 3: "‚òÅÔ∏è Overcast",
    45: "üå´ Fog", 48: "üå´ Rime fog", 51: "üå¶ Drizzle", 53: "üå¶ Mod. drizzle", 55: "üåß Dense drizzle",
    61: "üå¶ Slight rain", 63: "üåß Mod. rain", 65: "üåß Heavy rain", 71: "üå® Slight snow",
    73: "üå® Mod. snow", 75: "‚ùÑÔ∏è Heavy snow", 77: "üå® Snow grains", 80: "üåß Showers",
    81: "üåß Heavy showers", 82: "üåß Violent showers", 95: "‚õà Thunderstorm",
    96: "‚õà Hail Storm", 99: "üå© Severe Storm"
  };

  const container = document.getElementById("cities");
  const foodGallery = document.getElementById("food-gallery");
  const drinkGallery = document.getElementById("drink-gallery");
  const linkGallery = document.getElementById("link-gallery");

  // --- Currency Logic ---
  async function updateCurrency() {
    try {
        const res = await fetch("https://api.frankfurter.app/latest?from=EUR&to=USD,TRY");
        const data = await res.json();
        document.querySelector("#eur-usd span").textContent = data.rates.USD.toFixed(2);
        document.querySelector("#eur-try span").textContent = data.rates.TRY.toFixed(2);
    } catch (e) {
        console.error("Currency Error", e);
    }
  }

  // --- Image Compression ---
  function resizeImage(file, callback) {
    const reader = new FileReader();
    reader.onload = function(event) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            const maxWidth = 800; 
            let width = img.width;
            let height = img.height;

            if (width > maxWidth) {
                height = height * (maxWidth / width);
                width = maxWidth;
            }

            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            const dataUrl = canvas.toDataURL("image/jpeg", 0.7); 
            callback(dataUrl);
        };
        img.src = event.target.result;
    };
    reader.readAsDataURL(file);
  }

  // --- City UI ---
  cities.forEach(city => {
    const div = document.createElement("div");
    div.className = "city";
    div.innerHTML = `
      <img src="${city.img}" alt="${city.name}"> 
      <div class="city-info">
        <h3>${city.name}</h3>
        <p class="time">--:--</p>
        <p class="temp">-- ¬∞C</p>
        <p class="condition">--</p> 
        <div class="actions">
            <label class="action-btn" title="Upload Photo">
                üì∑ <input type="file" class="file-input" accept="image/*">
            </label>
        </div>
      </div>
    `;
    container.appendChild(div);
    city.element = div;

    div.querySelector(".file-input").addEventListener("change", (e) => {
        if (e.target.files[0]) {
            resizeImage(e.target.files[0], (dataUrl) => {
                set(ref(db, "cities/" + city.name + "/img"), dataUrl);
            });
        }
    });

    onValue(ref(db, "cities/" + city.name + "/img"), snap => {
      if(snap.val()) div.querySelector("img").src = snap.val();
    });
  });

  // --- SHARED LINKS LOGIC ---
  function getLinkPreviewImage(url) {
      // 1. YouTube
      const ytMatch = url.match(/(?:youtu\.be\/|youtube\.com\/(?:.*v=|.*\/)([\w-]{11}))/);
      if (ytMatch && ytMatch[1]) {
          return `https://img.youtube.com/vi/${ytMatch[1]}/0.jpg`;
      }
      // 2. Generic Placeholder (used because we can't scrape websites client-side)
      return "https://cdn-icons-png.flaticon.com/512/888/888856.png"; 
  }

  document.getElementById("add-link-btn").addEventListener("click", () => {
      const urlInput = document.getElementById("link-url");
      const titleInput = document.getElementById("link-title");
      const url = urlInput.value.trim();
      const title = titleInput.value.trim() || "Shared Link";

      if (url) {
          // Normalize URL
          let finalUrl = url;
          if (!url.startsWith("http")) finalUrl = "https://" + url;

          const previewImg = getLinkPreviewImage(finalUrl);
          
          push(ref(db, "links"), { 
              url: finalUrl, 
              title: title, 
              img: previewImg,
              timestamp: Date.now() 
          });
          
          urlInput.value = "";
          titleInput.value = "";
      } else {
          alert("Please paste a valid URL!");
      }
  });

  onValue(ref(db, "links"), snap => {
    linkGallery.innerHTML = "";
    const data = snap.val();
    if (!data) {
        linkGallery.innerHTML = '<p style="grid-column: 1/-1; text-align: center; opacity: 0.7;">No shared links yet.</p>';
        return;
    }
    Object.keys(data).reverse().forEach(key => { // Reverse to show newest first
        const item = data[key];
        const div = document.createElement("div");
        div.className = "gallery-item";
        div.innerHTML = `
            <a href="${item.url}" target="_blank" class="link-item">
                <img src="${item.img}" loading="lazy">
                <div class="link-overlay">${item.title}</div>
            </a>
            <button class="delete-btn" title="Delete">üóëÔ∏è</button>
        `;
        div.querySelector(".delete-btn").addEventListener("click", () => {
            if(confirm("Delete this link?")) remove(ref(db, "links/" + key));
        });
        linkGallery.appendChild(div);
    });
  });

  // --- GENERIC UPLOAD FUNCTION (Food & Drinks) ---
  function setupUploadSection(inputId, dbPath, galleryId, emptyMsg) {
      document.getElementById(inputId).addEventListener("change", (e) => {
        if (e.target.files[0]) {
            resizeImage(e.target.files[0], (dataUrl) => {
                push(ref(db, dbPath), { url: dataUrl, timestamp: Date.now() });
            });
        }
      });

      onValue(ref(db, dbPath), snap => {
        const gallery = document.getElementById(galleryId);
        gallery.innerHTML = "";
        const data = snap.val();
        
        if (!data) {
            gallery.innerHTML = `<p style="grid-column: 1/-1; text-align: center; opacity: 0.7;">${emptyMsg}</p>`;
            return;
        }

        Object.keys(data).forEach(key => {
            const item = data[key];
            const div = document.createElement("div");
            div.className = "gallery-item";
            div.innerHTML = `
                <img src="${item.url}" loading="lazy">
                <button class="delete-btn" title="Delete">üóëÔ∏è</button>
            `;
            div.querySelector(".delete-btn").addEventListener("click", () => {
                if(confirm("Delete this photo?")) remove(ref(db, `${dbPath}/${key}`));
            });
            // Insert at top (newest first)
            gallery.insertBefore(div, gallery.firstChild);
        });
      });
  }

  // Initialize Food & Drink Sections
  setupUploadSection("food-input", "foods", "food-gallery", "No food photos yet.");
  setupUploadSection("drink-input", "drinks", "drink-gallery", "No drink photos yet.");

  // --- Time & Weather ---
  function updateTime() {
    const now = new Date();
    cities.forEach(city => {
      const timeStr = now.toLocaleTimeString("en-GB", { timeZone: city.timezone, hour: "2-digit", minute: "2-digit" });
      city.element.querySelector(".time").textContent = timeStr;
    });
  }

  async function updateWeather() {
    for (const city of cities) {
      try {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current_weather=true`;
        const res = await fetch(url);
        const data = await res.json();
        const code = data.current_weather.weathercode;
        city.element.querySelector(".temp").textContent = `${data.current_weather.temperature} ¬∞C`;
        city.element.querySelector(".condition").textContent = weatherDescriptions[code] || "Unknown";
      } catch {
        city.element.querySelector(".temp").textContent = "N/A";
      }
    }
  }

  updateTime(); setInterval(updateTime, 1000);
  updateWeather(); setInterval(updateWeather, 10 * 60 * 1000);
  updateCurrency(); setInterval(updateCurrency, 60 * 60 * 1000);

</script>
</body>
</html>
